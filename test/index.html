<!DOCTYPE html>
<html>
<head>
<title>COAP extension app (JS to native-Arduino Mega2560 Kit)</title>
<link rel="stylesheet" type="text/css" href="style.css"/>
<meta name="viewport" content="width=device-width">
<style>
body {
  font-size: 2em;
}
</style>
</head>
<body>
  <video autoplay loop width="100%" height="100%">
      <source src="/usr/share/media/videos/AmazingNature_480p.mp4" type="video/mp4">
  </video>
  <div class="coap-app">

    <div class="coap-sensors">
      <div class="coap-sensor" id="b1">
        <span class="coap-sensor-pic">
          <img id="b1_img" src="" data_on="resources/cooktop_on.jpg" data_off="resources/cooktop_off.jpg">
        </span>
        <span class="coap-sensor-name">Cooktop</span>
        <span class="coap-sensor-desc">Kitchen</span>
        <span class="coap-sensor-state" id="b1_state">0</span>
      </div>
      <div class="coap-sensor" id="mailbox">
        <span class="coap-sensor-pic">
          <img src="resources/mailbox.png">
        </span>
        <span class="coap-sensor-name">Mail box</span>
        <span class="coap-sensor-desc">External</span>
        <span class="coap-sensor-state" id="mailbox_state">0</span>
      </div>
      <div class="coap-sensor" id="Temperature">
        <span class="coap-sensor-pic">
          <img src="resources/temperature.jpg" id="T_img">
        </span>
        <span class="coap-sensor-name">Temperature</span>
        <span class="coap-sensor-desc">Living room</span>
        <span class="coap-sensor-state" id="T_state">0</span>
      </div>
      <div class="coap-sensor" id="Motion">
        <span class="coap-sensor-pic">
          <img src="resources/intrusion.jpg">
        </span>
        <span class="coap-sensor-name">Motion</span>
        <span class="coap-sensor-desc">Entrance</span>
        <span class="coap-sensor-state" id="M_state">0</span>
      </div>
      <div class="coap-sensor" id="Distance">
        <span class="coap-sensor-pic">
          <img src="resources/distance.png">
        </span>
        <span class="coap-sensor-name">Distance (cm)</span>
        <span class="coap-sensor-desc">Garage</span>
        <span class="coap-sensor-state" id="D_state">0</span>
      </div>
      <div class="coap-sensor" id="Luminosity">
        <span class="coap-sensor-pic">
          <img src="resources/daylight.jpg">
        </span>
        <span class="coap-sensor-name">Luminosity</span>
        <span class="coap-sensor-desc">Garden (0-1023)</span>
        <span class="coap-sensor-state" id="L_state">0</span>
      </div>
      <div class="coap-sensor" id="TizenLogo">
<!--
      <img id="logo_tizen_img" src="resources/tizen_logo.jpg" width="160px" height="60px">
-->
      <input type="button" value="" onclick="onclickbuttonlogo(id)" class="buttonlogo" id="buttonlogo"/>

      </div>


      <div class="coap-sensor">
      <input type="text" id="serveraddr" value="coap://172.21.122.78" size="18" height="20px">
      </div>

    </div>

    <div class="coap-devices" id="coap-devices">
      <div class="coap-device" id="l1">
        <span class="coap-device-pic">
          <img id="l1_img" src="" data_on="resources/lightbulb_on.jpg" data_off="resources/lightbulb_off.jpg">
        </span>
        <span class="coap-device-name">Light1</span>
        <span class="coap-device-desc">Entrance</span>
        <span class="coap-device-state" id="l1_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="l1">On/Off</button>
      </div>
      <div class="coap-device" id="l2">
        <span class="coap-device-pic">
          <img id="l2_img" src="" data_on="resources/lightbulb_on.jpg" data_off="resources/lightbulb_off.jpg">
        </span>
        <span class="coap-device-name">Light2</span>
        <span class="coap-device-desc">Kitchen</span>
        <span class="coap-device-state" id="l2_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="l2" >On/Off</button>
      </div>    
      <div class="coap-device" id="l3">
        <span class="coap-device-pic">
          <img id="l3_img" src="" data_on="resources/lightbulb_on.jpg" data_off="resources/lightbulb_off.jpg">
        </span>
        <span class="coap-device-name">Light3</span>
        <span class="coap-device-desc">Living room</span>
        <span class="coap-device-state" id="l3_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="l3">On/Off</button>
      </div>
      <div class="coap-device" id="l4">
        <span class="coap-device-pic">
          <img id="l4_img" src="" data_on="resources/lightbulb_on.jpg" data_off="resources/lightbulb_off.jpg">
        </span>
        <span class="coap-device-name">PushLight4</span>
        <span class="coap-device-desc">Room</span>
        <span class="coap-device-state" id="l4_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="l4">On/Off</button>
      </div>
      <div class="coap-device" id="l5">
        <span class="coap-device-pic">
          <img id="l5_img" src="" data_on="resources/lightbulb_on.jpg" data_off="resources/lightbulb_off.jpg">
        </span>
        <span class="coap-device-name">PushLight5</span>
        <span class="coap-device-desc">Garden</span>
        <span class="coap-device-state" id="l5_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="l5">On/Off</button>
      </div>
      <div class="coap-device" id="servo">
        <span class="coap-device-pic">
          <img src="resources/windowblind_on.png">
        </span>
        <span class="coap-device-name">Window blind</span>
        <span class="coap-device-desc">Living room</span>
        <span class="coap-device-state" id="servo_state">1</span>
        <button class="coap-device-button" onclick="onclickbutton(id)" id="servo" >On/Off</button>
      </div>

      <div class="pip_div" id="pip_div">
          <video autoplay loop width="300px" height="200px" muted>
          <source src="/usr/share/media/videos/AmazingNature_480p.mp4#t=60" type="video/mp4">
<!-- IP webcam
          <source src="http://10.148.28.16:8080" type="video/mp4">
-->
          </video>
      </div>

    </div>


   </div>

   <div id="clear_float_div" style="clear:both;"></div>
<!--
    <div class="coap-app-bottom">
      
    </div>
-->
  </div>


<!--
<button id="button_setLight"  onclick="onclickbutton()" > 
    SetLightl</button>

<div id="out"></div>
-->


<script>



var lightList = ["l1", "l2", "l3", "l4", "l5"];
var sensorList = ["T", "D", "M", "L"];
var deviceIP = "coap://224.0.1.187";
var deviceState = {};



var div = document.getElementById('out');

var p1 = document.createElement('p');
var p2 = document.createElement('p');
var p3 = document.createElement('p');



var l1 = document.createElement('p');


function getServerAddr(){

    newAddr = document.getElementById("serveraddr").value;
    if (newAddr != "")
    {
        deviceIP = newAddr;
    }

    return deviceIP;
}

function getDeviceState(id){

  // Skip first line
  var response;
  response = coap.getDeviceSync(getServerAddr(), id); // SYNC
/*
  // ASYNC call
  coap.getDevice(getServerAddr(), id, function (result) {
  response = result;
   });
*/
  var responseArray = response.split('\n');

  var value = "";
  if (responseArray.length >= 2)
  {
      value = responseArray[1];
      deviceState[id] = value;
  }

  return value;
}

function updatedeviceimage(id, currentState){

  var imageIdObj = document.getElementById(id + "_img");
  if (imageIdObj)
  {
  var imageon = imageIdObj.getAttribute("data_on");
  var imageoff = imageIdObj.getAttribute("data_off");
  if (currentState == 0)
  {
    imagetochange = imageoff;
  }
  else
  {
    imagetochange = imageon;
  }

  imageIdObj.src = imagetochange;
  }
}

function getandupdatedeviceimage(id){

  var currentState = getDeviceState(id);
  updatedeviceimage(id, currentState);
}


function updatedevicestate(id){

  var currentState = getDeviceState(id);
  var deviceObj = document.getElementById(id + "_state");
  if (deviceObj)
  {
     deviceObj.innerHTML = currentState;
  }

  return currentState;
}




function onclickbuttonlogo(id){

  var docObj = document.getElementById("coap-devices");
  if (docObj)
  {
    var currentStyle = docObj.style.display;
    if (currentStyle == 'block')
      docObj.style.display = 'none';
    else
      docObj.style.display = 'block';
  }

}



function onclickbutton(id){

    // Toggle state
    if (id != "servo")
    {
      var currentState = 0;
      var desiredState = 0;

      currentState = deviceState[id]; //getDeviceState(id);
      if (currentState == 0)
      {
        desiredState = 1;
      }
      else
      {
        desiredState = 0;
      }

      deviceState[id] = desiredState;

      updatedeviceimage(id, desiredState);

      coap.setDevice(getServerAddr(), id, desiredState);
    }
    else if (id == "servo")
    {
      var currentState = 0;
      var desiredState = 0;

      currentState = deviceState[id]; //getDeviceState(id);
      if (currentState == 90)
      {
        desiredState = 270;
      }
      else
      {
        desiredState = 90;
      }

      deviceState[id] = desiredState;

      //desiredState = (parseInt(currentState) + 90) % 360;

      coap.setDevice(getServerAddr(), id, desiredState);
    }
}

function getSensorsState(){

    var value;
    var i;
/*
    for(i = 0; i < sensorList.length; i++)
    {
        updatedevicestate(sensorList[i]);
    }

    var currentState = updatedevicestate("b1");
    updatedeviceimage("b1", currentState);
    updatedevicestate("b2");


    currentState = updatedevicestate("l4");
    updatedeviceimage("l4", currentState);
    currentState = updatedevicestate("l5");
    updatedeviceimage("l5", currentState);

    updatedevicestate("relai");
    updatedevicestate("servo");
*/

    var currentAllStates = getDeviceState("alldevices");
    var allDevicesArray = currentAllStates.split(";");
    for (var i = 0; i < allDevicesArray.length; i++)
    {
        var deviceStateString = allDevicesArray[i];
        var deviceStateArray = deviceStateString.split("=");
        if (deviceStateArray.length >= 2)
        {
           // Update innerHTML
           var id = deviceStateArray[0];
           var currentState = deviceStateArray[1];
           var deviceObj = document.getElementById(id + "_state");
           if (deviceObj)
           {
               deviceObj.innerHTML = currentState;
           }

           deviceState[id] = currentState;
        }
    }

    updatedeviceimage("l1", deviceState["l1"]);
    updatedeviceimage("l2", deviceState["l2"]);
    updatedeviceimage("l3", deviceState["l3"]);
    updatedeviceimage("l4", deviceState["l4"]);
    updatedeviceimage("l5", deviceState["l5"]);

    updatedeviceimage("b1", deviceState["b1"]);
    updatedeviceimage("b2", deviceState["b2"]);

    var now = new Date().toLocaleString();
    //now.format("dd/MM/yyyy hh:MM TT");
    var deviceObj = document.getElementById("currentdatetime");
    deviceObj.innerHTML = now;
    //deviceObj.innerHTML = deviceState["l5"]; //allDevicesArray.length.toString();
}


var pollingdelay = 1000;

var pollingfunction = function(){

    getSensorsState();
    setTimeout(pollingfunction, pollingdelay);
}

function applicationinit(){

    pollingfunction();
}




applicationinit()



/*
// async call to extension
coap.echoAsync('hello async echo', function (result) {
  p1.innerText = result;
  div.appendChild(p1);
});

// sync call to extension
p2.innerText = coap.echoSync('hello sync echo');
div.appendChild(p2);

p3.innerText = coap.setLight('devicename', 1);
div.appendChild(p3);




*/


</script>
</body>
</html>


